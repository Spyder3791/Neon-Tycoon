<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neon Tycoon v2.1 (Managers Update)</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* --- CSS VARIABLES --- */
        :root {
            --bg-color: #050a14;
            --panel-bg: rgba(12, 24, 45, 0.95);
            --neon-blue: #00f3ff;
            --neon-pink: #ff00ff;
            --text-color: #e6faff;
            --neon-green: #39ff14;
            --neon-red: #ff3939;
            --neon-yellow: #fff700;
            --neon-orange: #ff9e00;
        }

        /* --- GLOBAL --- */
        body {
            margin: 0; padding: 0;
            background-color: var(--bg-color);
            background-image: 
                linear-gradient(rgba(0, 243, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 243, 255, 0.03) 1px, transparent 1px);
            background-size: 40px 40px;
            color: var(--text-color);
            font-family: 'Orbitron', sans-serif;
            font-size: 16px;
            letter-spacing: 0.5px;
            min-height: 100vh;
            display: flex; justify-content: center; align-items: center;
            user-select: none; overflow: hidden; 
        }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.3); border-radius: 4px; }
        ::-webkit-scrollbar-thumb { background: var(--neon-blue); border-radius: 4px; border: 1px solid #000; }
        ::-webkit-scrollbar-thumb:hover { background: var(--neon-pink); }

        body::after {
            content: " "; display: block; position: absolute; top: 0; left: 0; bottom: 0; right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            z-index: 9998; background-size: 100% 2px, 3px 100%; pointer-events: none; 
        }

        #confetti-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999; }

        /* --- LAYOUT --- */
        #game-layout {
            display: none; width: 95%; max-width: 1200px; height: 90vh;
            display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: auto 1fr; gap: 25px;
        }
        @media (max-width: 768px) {
            #game-layout { display: flex; flex-direction: column; height: auto; overflow-y: auto; padding-bottom: 50px; }
            .panel { height: auto !important; }
        }

        .panel {
            background: var(--panel-bg); border: 1px solid var(--neon-blue);
            box-shadow: 0 0 15px rgba(0, 243, 255, 0.15), inset 0 0 20px rgba(0, 243, 255, 0.05);
            padding: 25px; border-radius: 10px; backdrop-filter: blur(8px);
            display: flex; flex-direction: column; position: relative;
        }

        /* --- NEWS TICKER --- */
        .news-bar {
            grid-column: 1 / -1; background: #000; border-top: 2px solid var(--neon-blue); border-bottom: 2px solid var(--neon-blue);
            height: 45px; display: flex; align-items: center; overflow: hidden; white-space: nowrap; position: relative;
            font-size: 1rem;
        }
        .news-label { background: var(--neon-blue); color: #000; font-weight: bold; padding: 0 20px; height: 100%; display: flex; align-items: center; z-index: 2; }
        .marquee { display: inline-block; padding-left: 100%; animation: marquee 20s linear infinite; color: var(--neon-yellow); }
        @keyframes marquee { 0% { transform: translate(0, 0); } 100% { transform: translate(-100%, 0); } }

        /* --- LEFT COLUMN --- */
        .col-left { display: flex; flex-direction: column; gap: 20px; }
        .currency-display { font-size: 3.2rem; color: var(--neon-green); text-shadow: 0 0 10px var(--neon-green); font-weight: 700; margin: 15px 0; word-break: break-all;}
        .stat-box { display: flex; justify-content: space-around; border-bottom: 1px solid #333; padding-bottom: 15px; margin-bottom: 20px; font-size: 1.1rem; }
        
        /* STABILITY METER */
        .stability-container { margin-bottom: 15px; text-align: left; }
        .stability-bar-bg { background: #333; height: 20px; width: 100%; border-radius: 4px; overflow: hidden; border: 1px solid #555; position: relative;}
        .stability-bar-fill { height: 100%; background: var(--neon-green); width: 100%; transition: width 0.5s, background 0.5s; }
        .stability-text { position: absolute; width: 100%; text-align: center; top: 0; line-height: 20px; font-size: 0.8rem; color: #fff; text-shadow: 1px 1px 2px black; font-weight: bold; }
        
        /* Avatar */
        #ceo-avatar-display {
            width: 100px; height: 100px; margin: 0 auto 10px auto; border-radius: 50%; border: 3px solid var(--neon-blue);
            background-image: url('avatars.jpg'); background-repeat: no-repeat; background-size: 215% 215%; 
            box-shadow: 0 0 20px rgba(0, 243, 255, 0.3); background-color: #222;
        }

        #main-clicker {
            width: 180px; height: 180px; margin: 10px auto; border-radius: 50%; border: 5px solid var(--neon-blue);
            box-shadow: 0 0 40px rgba(0, 243, 255, 0.4); display: flex; justify-content: center; align-items: center;
            font-size: 80px; cursor: pointer; transition: 0.1s; background: rgba(0, 243, 255, 0.05); user-select: none;
        }
        #main-clicker:active { transform: scale(0.96); }
        #main-clicker.cooldown { border-color: #555; filter: grayscale(1); cursor: wait; }

        .badge-row { display: flex; justify-content: center; gap: 15px; margin-top: 15px; min-height: 40px; }
        .badge { width: 35px; height: 35px; border-radius: 50%; background: #333; display: flex; justify-content: center; align-items: center; font-size: 18px; color: #555; border: 1px solid #555; transition: all 0.3s; }
        .badge.unlocked { background: var(--neon-yellow); color: #000; box-shadow: 0 0 15px var(--neon-yellow); border-color: #fff; animation: popIn 0.5s; }

        /* --- RIGHT COLUMN --- */
        .col-right { display: flex; flex-direction: column; height: 100%; }
        .tab-header { display: flex; border-bottom: 1px solid var(--neon-blue); margin-bottom: 15px; flex-shrink: 0; }
        .tab-btn {
            flex: 1; background: transparent; border: none; color: #888; padding: 15px 10px; 
            font-family: 'Orbitron'; cursor: pointer; font-size: 0.9rem; transition: 0.3s;
        }
        .tab-btn:hover { color: #fff; background: rgba(255,255,255,0.05); }
        .tab-btn.active { background: rgba(0, 243, 255, 0.1); color: var(--neon-blue); border-bottom: 3px solid var(--neon-blue); font-weight: bold; text-shadow: 0 0 8px var(--neon-blue); }
        
        .tab-content { display: none; height: 100%; flex-direction: column; overflow: hidden; }
        .tab-content.active { display: flex; }
        
        .scroll-list { 
            display: flex; flex-direction: column; gap: 10px; 
            overflow-y: auto; flex: 1 1 auto; height: 0; 
            padding-right: 5px; min-height: 0; padding-bottom: 50px; 
        }

        .list-item { 
            background: rgba(0,0,0,0.6); border: 1px solid #444; padding: 12px; 
            display: flex; justify-content: space-between; align-items: center; border-radius: 6px; flex-shrink: 0;
        }
        
        .manager-item {
            background: rgba(50, 40, 0, 0.6); border: 1px solid var(--neon-yellow);
        }

        /* --- STOCK CARD --- */
        .stock-item { background: rgba(0,0,0,0.5); border: 1px solid #444; padding: 12px; border-radius: 4px; display: flex; flex-direction: column; gap: 8px; flex-shrink: 0; }
        .stock-row-top { display: flex; justify-content: space-between; align-items: center; font-size: 1.1rem; }
        .stock-row-bot { display: flex; justify-content: flex-end; gap: 8px; margin-top: 5px; flex-wrap: wrap;}

        #market-chart-container { 
            width: 100%; background: #000; border: 1px solid #333; 
            height: 180px; flex-shrink: 0; position: relative; margin-bottom: 20px; 
        }
        canvas { width: 100%; height: 100%; }

        /* --- ROCKET BUILDER --- */
        #rocket-silo {
            width: 100%; height: 300px; background: rgba(0,0,0,0.5); 
            border: 1px solid #333; margin-top: 15px; position: relative;
            display: flex; flex-direction: column-reverse; align-items: center; justify-content: center;
            padding-bottom: 20px; overflow: hidden;
            background-image: linear-gradient(rgba(0, 243, 255, 0.05) 1px, transparent 1px), linear-gradient(90deg, rgba(0, 243, 255, 0.05) 1px, transparent 1px);
            background-size: 20px 20px; flex-shrink: 0;
        }
        .rocket-part { width: 70px; margin-bottom: 3px; transition: all 0.5s; border: 2px dashed rgba(0, 243, 255, 0.3); background: transparent; box-sizing: border-box; opacity: 0.6; }
        .rocket-part.built { opacity: 1; border-style: solid; border-color: var(--neon-blue); box-shadow: 0 0 20px rgba(0,243,255,0.4); }
        #part-1 { height: 50px; width: 90px; border-radius: 5px 5px 20px 20px; }
        #part-1.built { background: linear-gradient(0deg, var(--neon-pink), #222); border-color: var(--neon-pink); }
        #part-2 { height: 90px; width: 70px; }
        #part-2.built { background: linear-gradient(90deg, #222, #444, #222); }
        #part-3 { height: 80px; width: 70px; }
        #part-3.built { background: #333; border-top: 2px solid var(--neon-green); }
        #part-4 { height: 60px; width: 60px; border-radius: 50% 50% 5px 5px; }
        #part-4.built { background: var(--neon-blue); }
        .rocket-launching .rocket-part { animation: launchAnim 3s ease-in forwards; }
        @keyframes launchAnim { 0% { transform: translateY(0); } 5% { transform: translateY(5px); } 100% { transform: translateY(-800px); } }

        /* --- MODALS --- */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 5000; justify-content: center; align-items: center;
        }
        .popup-box {
            background: var(--bg-color); border: 2px solid var(--neon-blue); padding: 30px; width: 350px;
            box-shadow: 0 0 50px rgba(0, 243, 255, 0.3); text-align: center; border-radius: 12px; position: relative;
        }
        #achievement-popup .popup-box { border-color: var(--neon-yellow); box-shadow: 0 0 60px rgba(255, 247, 0, 0.4); }
        #embezzle-popup.failed .popup-box { border-color: var(--neon-red); box-shadow: 0 0 50px rgba(255, 57, 57, 0.4); }
        #embezzle-popup.success .popup-box { border-color: var(--neon-green); box-shadow: 0 0 50px rgba(57, 255, 20, 0.4); }

        /* Setup Screen */
        #setup-screen { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; max-width: 500px; z-index: 2000; }
        .logo-opt { transition: all 0.2s ease; }
        .logo-opt:hover { color: var(--neon-green); text-shadow: 0 0 15px var(--neon-green); transform: scale(1.1); }
        .logo-opt.selected { color: var(--neon-blue); text-shadow: 0 0 25px var(--neon-blue); transform: scale(1.2); }
        .avatar-grid { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px; justify-content: center; margin-top: 10px; }
        .avatar-option {
            width: 80px; height: 80px; border: 2px solid #555; border-radius: 10px;
            background-image: url('avatars.jpg'); background-size: 215% 215%; background-repeat: no-repeat;
            cursor: pointer; transition: 0.2s; filter: grayscale(100%); background-color: #222;
        }
        .avatar-option:hover { filter: grayscale(0%); border-color: var(--neon-blue); }
        .avatar-option.selected { filter: grayscale(0%); border-color: var(--neon-blue); box-shadow: 0 0 20px var(--neon-blue); transform: scale(1.1); }

        .av-1 { background-position: 0% 0%; }
        .av-2 { background-position: 100% 0%; }
        .av-3 { background-position: 0% 100%; }
        .av-4 { background-position: 100% 100%; }

        /* --- UTILS --- */
        input[type="text"] { background: #000; border: 1px solid var(--neon-blue); color: var(--neon-blue); padding: 12px; width: 100%; font-family: 'Orbitron'; text-align: center; box-sizing: border-box; font-size: 1.1rem; }
        .btn { background: transparent; border: 1px solid var(--neon-pink); color: var(--neon-pink); padding: 10px 18px; font-family: 'Orbitron'; cursor: pointer; text-transform: uppercase; font-size: 0.9rem; transition: 0.2s; }
        .btn:hover:not(:disabled) { background: var(--neon-pink); color: #000; box-shadow: 0 0 15px var(--neon-pink); }
        .btn:disabled { border-color: #333; color: #555; background: #111; cursor: not-allowed; box-shadow: none; }
        #btn-start { transition: all 0.3s; }
        .btn-sm { font-size: 0.7rem; padding: 5px 10px; min-width: 35px; }
        .btn-danger { border-color: var(--neon-red); color: var(--neon-red); }
        .btn-danger:hover:not(:disabled) { background: var(--neon-red); color: #fff; box-shadow: 0 0 15px var(--neon-red); }
        .accent-text { color: var(--neon-pink); }
        .floating-text { position: absolute; font-weight: bold; font-size: 1.2rem; pointer-events: none; animation: floatUp 0.8s ease-out forwards; z-index: 1000; text-shadow: 1px 1px 0 #000; }
        @keyframes floatUp { 0% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-60px); } }
        @keyframes popIn { 0% { transform: scale(0); } 80% { transform: scale(1.2); } 100% { transform: scale(1); } }
    </style>
</head>
<body>

    <canvas id="confetti-canvas"></canvas>

    <div id="setup-screen" class="panel">
        <h2 style="text-align: center; color: var(--neon-blue);">IDENTITY UPLINK</h2>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div>
                <div style="margin-bottom: 15px;"><label>CEO ALIAS</label><input type="text" id="input-player-name" placeholder="Enter Name"></div>
                <div style="margin-bottom: 15px;"><label>CORP NAME</label><input type="text" id="input-company-name" placeholder="Enter Corp"></div>
            </div>
            <div style="text-align: center;">
                <label>CORP ICON</label>
                <div style="display: flex; justify-content: center; gap: 10px; margin-top: 5px; font-size: 2rem; cursor: pointer;">
                    <span class="logo-opt" onclick="selectLogo('‚öõÔ∏è', this)">‚öõÔ∏è</span>
                    <span class="logo-opt" onclick="selectLogo('üí†', this)">üí†</span>
                    <span class="logo-opt" onclick="selectLogo('üßø', this)">üßø</span>
                    <span class="logo-opt" onclick="selectLogo('‚öôÔ∏è', this)">‚öôÔ∏è</span>
                </div>
            </div>
        </div>
        <div style="margin: 15px 0; text-align: center;">
            <label style="color: var(--neon-orange);">SELECT CEO AVATAR</label>
            <div class="avatar-grid">
                <div class="avatar-option av-1" onclick="selectAvatar(1, this)"></div>
                <div class="avatar-option av-2" onclick="selectAvatar(2, this)"></div>
                <div class="avatar-option av-3" onclick="selectAvatar(3, this)"></div>
                <div class="avatar-option av-4" onclick="selectAvatar(4, this)"></div>
            </div>
        </div>
        <button id="btn-start" class="btn" style="width: 100%; font-size: 1.1rem; padding: 15px;" disabled>ESTABLISH CONNECTION</button>
    </div>

    <div id="game-layout" style="display: none;">
        
        <div class="news-bar">
            <div class="news-label">CYBER-FEED</div>
            <div class="marquee" id="news-ticker">Welcome to the Neon City Network...</div>
        </div>

        <div class="col-left">
            <div class="panel" style="flex: 1; text-align: center;">
                <div id="ceo-avatar-display"></div>
                <h3 id="company-display" class="accent-text" style="margin: 0; font-size: 1.5rem;">CORP NAME</h3>
                <div style="font-size: 0.9rem; color: #888;">CEO: <span id="ceo-display">User</span></div>
                
                <div class="currency-display">$<span id="currency-count">0</span></div>
                
                <div class="stability-container">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                        <div>
                            <span style="color:#aaa; font-size:0.8rem;">CITY STABILITY</span>
                            <button class="btn btn-sm" style="padding: 0 5px; margin-left: 5px; border-radius: 50%; font-size: 0.7rem;" onclick="document.getElementById('stability-help-modal').style.display='flex'">?</button>
                        </div>
                        <span id="stability-val" style="color:var(--neon-green); font-size:0.8rem;">100%</span>
                    </div>
                    <div class="stability-bar-bg">
                        <div id="stability-fill" class="stability-bar-fill"></div>
                        <div id="stability-overlay" class="stability-text">STABLE</div>
                    </div>
                    <button id="btn-repair" class="btn btn-sm" style="width:100%; margin-top:5px; display:none;" onclick="bribeOfficials()">
                        BRIBE OFFICIALS ($10,000)
                    </button>
                </div>

                <div class="stat-box">
                    <div>Click: <span class="accent-text">+$<span id="click-power-display">1</span></span></div>
                    <div>Passive: <span style="color: var(--neon-blue)">+$<span id="passive-income-display">0</span>/s</span></div>
                </div>

                <div class="badge-row">
                    <div id="badge-1" class="badge" title="100 Clicks">üñ±Ô∏è</div>
                    <div id="badge-2" class="badge" title="$10,000 Earned">üí∞</div>
                    <div id="badge-3" class="badge" title="First Hire">ü§ù</div>
                    <div id="badge-4" class="badge" title="Market Mogul">üìà</div>
                    <div id="badge-5" class="badge" title="Space Age">üöÄ</div>
                </div>

                <div id="main-clicker"></div>

                <div style="margin-top: auto;">
                    <div style="font-size: 0.8rem; color: #aaa; display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span>CLEARANCE LEVEL <span id="current-level-display" style="color:white;">1</span></span>
                        <span id="progress-text">0 / 50</span>
                    </div>
                    <div style="background: #000; height: 12px; border-radius: 6px; overflow: hidden; border: 1px solid #333;">
                        <div id="progress-bar-fill" style="width: 0%; height: 100%; background: var(--neon-pink); transition: width 0.3s;"></div>
                    </div>
                </div>
            </div>

            <div class="panel" style="flex-direction: row; justify-content: space-between; align-items: center; padding: 15px 20px;">
                <span style="font-size: 0.8rem; color: #666;">SYSTEM OS v2.1</span>
                <div>
                    <button class="btn" id="btn-save" onclick="saveGame(false)" style="font-size: 0.8rem;">SAVE</button>
                    <button class="btn btn-danger" onclick="resetGame()">WIPE</button>
                </div>
            </div>
        </div>

        <div class="col-right">
            <div class="panel" style="height: 100%; padding: 0; overflow: hidden;">
                <div class="tab-header">
                    <button class="tab-btn active" onclick="switchTab('staff')">STAFF</button>
                    <button class="tab-btn" onclick="switchTab('blackmarket')">UPGRADES</button>
                    <button class="tab-btn" onclick="switchTab('stocks')">MARKET</button>
                    <button class="tab-btn" style="color:var(--neon-green);" onclick="switchTab('projectx')">PROJECT X</button>
                </div>

                <div id="tab-staff" class="tab-content active">
                    <div class="scroll-list">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; flex-shrink: 0;">
                            <span>HUMAN RESOURCES <span id="staff-counter" style="font-size:0.8rem; color:#888;">(0/10)</span></span>
                            <button class="btn" id="btn-hire" style="font-size: 0.8rem;">HIRE ($<span id="hire-cost">500</span>)</button>
                        </div>
                        <div id="staff-list" style="margin-bottom: 20px;"></div>

                        <div style="border-top: 1px dashed #444; margin-bottom: 20px;"></div>

                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; flex-shrink: 0;">
                            <span style="color: var(--neon-yellow);">EXECUTIVE BOARD <span id="manager-counter" style="font-size:0.8rem;">(0/3)</span></span>
                            <button class="btn" id="btn-hire-manager" style="font-size: 0.8rem; border-color: var(--neon-yellow); color: var(--neon-yellow);" onclick="hireManager()">HEADHUNT ($50k)</button>
                        </div>
                        <div id="manager-list"></div>
                    </div>
                </div>

                <div id="tab-blackmarket" class="tab-content">
                    <div class="scroll-list">
                        <div style="color: #aaa; text-align: center; margin-bottom: 5px;">AVAILABLE BLACKMARKET GOODS</div>
                        <div id="upgrade-list"></div>
                        <div style="border-top: 1px dashed #444; margin: 20px 0;"></div>
                        <div style="color: var(--neon-green); text-align: center; margin-bottom: 5px;">ACQUIRED HARDWARE</div>
                        <div id="acquired-list"></div>
                    </div>
                </div>

                <div id="tab-stocks" class="tab-content">
                    <div id="market-chart-container">
                        <canvas id="market-chart"></canvas>
                        <div style="position: absolute; top: 8px; left: 10px; font-size: 0.7rem; color: #aaa;">NEO-INDEX (3s Interval)</div>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 15px; flex-shrink: 0;">
                        <span>MARKET LIST</span>
                        <span id="market-trend" style="font-size: 0.9rem;">TREND: VOLATILE</span>
                    </div>
                    <div id="stock-list" class="scroll-list"></div>
                    <div style="margin-top: 10px; border-top: 1px solid #333; padding-top: 10px; flex-shrink: 0;">
                        <button class="btn" style="width: 100%; border-color: var(--neon-yellow); color: var(--neon-yellow);" onclick="gamble()">EMBEZZLE FUNDS (RISK 25%)</button>
                    </div>
                </div>

                <div id="tab-projectx" class="tab-content">
                    <h3 style="text-align:center; color: var(--neon-green); margin-bottom: 5px; flex-shrink: 0;">PROJECT EXODUS</h3>
                    <p style="text-align:center; font-size:0.9rem; color:#aaa; margin-top:0; flex-shrink: 0;">Construct the escape vessel. Cost: $1 Billion.</p>
                    <div id="rocket-silo">
                        <div id="part-4" class="rocket-part"></div>
                        <div id="part-3" class="rocket-part"></div>
                        <div id="part-2" class="rocket-part"></div>
                        <div id="part-1" class="rocket-part"></div>
                    </div>
                    <div style="margin-top:25px; text-align:center; flex-shrink: 0;">
                        <div style="margin-bottom:15px; font-weight:bold; color:var(--neon-blue); font-size: 1.1rem;">
                            CURRENT PHASE: <span id="rocket-phase-name">Propulsion</span>
                        </div>
                        <button id="btn-fund-rocket" class="btn" style="width:100%; font-size:1.1rem; padding:18px;" onclick="fundRocket()">FUND PHASE ($100M)</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="stability-help-modal" class="modal-overlay">
        <div class="popup-box" style="text-align: left;">
            <h3 style="color: var(--neon-blue); text-align: center; margin-top: 0;">CITY STABILITY GUIDE</h3>
            <ul style="color: #ddd; font-size: 0.9rem; padding-left: 20px;">
                <li style="margin-bottom: 8px;">Stability decays slowly over time (-0.2%/sec).</li>
                <li style="margin-bottom: 8px;"><span style="color: var(--neon-orange)">BELOW 50%:</span> Civil Unrest begins.</li>
                <li style="margin-bottom: 8px;"><span style="color: var(--neon-red)">BELOW 20%:</span> Riots! Passive income reduced by 50%.</li>
                <li style="margin-bottom: 8px;"><span style="color: red; font-weight: bold;">AT 0%:</span> MARTIAL LAW. All passive income stops.</li>
            </ul>
            <p style="text-align: center; color: #aaa; font-size: 0.8rem;">Managers with "PR Specialist" perk reduce decay.</p>
            <div style="text-align: center;">
                <button class="btn" onclick="closeModal('stability-help-modal')">UNDERSTOOD</button>
            </div>
        </div>
    </div>

    <div id="anomaly-popup" class="modal-overlay">
        <div class="popup-box">
            <h3 class="accent-text" style="margin-top: 0;">ANOMALY DECODED</h3>
            <p style="color: #ddd; font-size: 1.1rem;">You successfully breached the data cache.</p>
            <h2 class="currency-display" style="font-size: 2.5rem;">+$<span id="anomaly-amount">0</span></h2>
            <button class="btn" onclick="closeModal('anomaly-popup')" style="font-size: 1.1rem; padding: 15px 30px;">ACKNOWLEDGE</button>
        </div>
    </div>

    <div id="hire-modal" class="modal-overlay">
        <div class="popup-box">
            <h3 style="color: var(--neon-blue);" id="modal-title-text">NEW CONTRACT</h3>
            <p>Enter designation:</p>
            <input type="text" id="new-hire-name" maxlength="15" placeholder="e.g. Cyber-Smith">
            <div style="margin-top: 20px; display: flex; justify-content: center; gap: 10px;">
                <button class="btn btn-danger" onclick="closeModal('hire-modal')">CANCEL</button>
                <button class="btn" onclick="confirmHire()">SIGN CONTRACT</button>
            </div>
        </div>
    </div>

    <div id="embezzle-popup" class="modal-overlay">
        <div class="popup-box">
            <h3 id="embezzle-title" style="margin-top: 0; font-size: 1.8rem;">TRANSACTION REPORT</h3>
            <p id="embezzle-message" style="color: #ddd; font-size: 1.2rem;">Decrypting...</p>
            <button class="btn" onclick="closeModal('embezzle-popup')" style="font-size: 1.1rem; padding: 15px 30px; margin-top: 10px;">ACKNOWLEDGE</button>
        </div>
    </div>

    <div id="achievement-popup" class="modal-overlay">
        <div class="popup-box">
            <h2 style="color: var(--neon-yellow);">ACHIEVEMENT UNLOCKED!</h2>
            <div id="achievement-icon" style="font-size: 4rem; margin: 10px 0;">üèÜ</div>
            <h4 id="achievement-title" style="margin: 0;">Title</h4>
            <p id="achievement-desc" style="color: #aaa; font-size: 0.9rem;">Description</p>
            <button class="btn" onclick="closeModal('achievement-popup')" style="margin-top: 15px;">AWESOME</button>
        </div>
    </div>

    <div id="anomaly" style="display: none; position: fixed; width: 50px; height: 50px; border-radius: 50%; background: red; box-shadow: 0 0 25px red; cursor: pointer; z-index: 4000;"></div>

    <script>
        const MAX_STAFF = 10;
        const MAX_MANAGERS = 3;
        const MANAGER_COST = 50000;
        
        const DEFAULT_STATE = {
            name: "", corp: "", 
            logo: null, 
            avatar: null, 
            cash: 0, clicks: 0, 
            staff: [], managers: [], upgrades: [], stocks: {},
            hireCost: 500, clickLevel: 0, achievements: [], rocketStage: 0,
            stability: 100,
            marketPrices: {}, 
            marketHistory: [] 
        };
        
        const MANAGER_PERKS = [
            { id: 'click_boost', name: 'Micro-Manager', desc: '+50% Click Power', type: 'click', val: 1.5 },
            { id: 'passive_boost', name: 'Efficiency Expert', desc: '+50% Staff Income', type: 'passive', val: 1.5 },
            { id: 'stability_boost', name: 'PR Specialist', desc: 'Stability Decay Halved', type: 'stability', val: 0.5 },
            { id: 'market_shark', name: 'Wolf of Wall St', desc: 'Passive Income x2', type: 'passive', val: 2.0 } 
        ];

        const STOCKS = [
            { sym: "OMNI", price: 100, vol: 0.05 }, { sym: "ZION", price: 45, vol: 0.08 },
            { sym: "FLUX", price: 250, vol: 0.03 }, { sym: "AURA", price: 15, vol: 0.15 },
            { sym: "NEXS", price: 500, vol: 0.02 }, { sym: "ECHO", price: 75, vol: 0.10 },
            { sym: "VOID", price: 10, vol: 0.20 }
        ];

        const ROCKET_PHASES = [
            { cost: 100000000, name: "Ion Thrusters" },
            { cost: 250000000, name: "Fuel Core" },
            { cost: 250000000, name: "Habitation Hull" },
            { cost: 400000000, name: "Command AI" }
        ];

        const UPGRADES = [
            { id: 'u1', name: 'Mouse Overclock', cost: 2500, mult: 2, type: 'click' },
            { id: 'u2', name: 'Fluid Cooling', cost: 8000, mult: 1.5, type: 'passive' },
            { id: 'u3', name: 'Neural Link', cost: 20000, mult: 3, type: 'click' },
            { id: 'u4', name: 'AI Manager', cost: 50000, mult: 2, type: 'passive' },
            { id: 'u5', name: 'Quantum Core', cost: 250000, mult: 2, type: 'all' }
        ];

        const ACHIEVEMENTS = [
            { id: 1, icon: "üñ±Ô∏è", title: "Clicker Initiate", desc: "Manual clicks exceed 100" },
            { id: 2, icon: "üí∞", title: "Venture Capitalist", desc: "Earn $10,000 Lifetime" },
            { id: 3, icon: "ü§ù", title: "Team Player", desc: "Hire your first staff member" },
            { id: 4, icon: "üìà", title: "Market Mogul", desc: "Own any stock asset" },
            { id: 5, icon: "üöÄ", title: "Space Age", desc: "Complete the Exodus Project" }
        ];

        const NEWS_ITEMS = [ 
            "Void Security announces major data breach... OMNI stocks shaky...", 
            "NEXS AI releases sentient chatbot... tech stocks rallying...", 
            "Project Exodus rumors confirmed by government officials...", 
            "Weather forecast: Acid Rain likely in Sector 7...", 
            "OmniCorp announces new cyber-implants... medical sector booms...",
            "ZION Corp mining drones malfunction... rare earth prices spike...",
            "FLUX Energy unveils cold fusion prototype... energy sector volatile...",
            "AURA Biotech facing lawsuit over genetic mod side effects...",
            "ECHO Systems buys out rival network... bandwidth prices drop...",
            "VOID Heavy Industries secures military contract... defense stocks up...",
            "Interstellar trade route blocked by space debris... cargo delays expected...",
            "Hackers leak classified schematics from AURA labs...",
            "Solar flares disrupt global communication networks...",
            "Underground racing league boosts demand for FLUX capacitors...",
            "Corporate tax hike proposed by World Government... market panic ensued..."
        ];

        let state = { ...DEFAULT_STATE };
        let cooldown = false;
        let hiringType = 'staff'; // 'staff' or 'manager'

        function init() {
            if(localStorage.getItem('neonV21')) {
                try {
                    let loaded = JSON.parse(localStorage.getItem('neonV21'));
                    state = { ...DEFAULT_STATE, ...loaded };
                    if(typeof state.stability === 'undefined') state.stability = 100;
                    if(!state.managers) state.managers = []; // Migration for managers

                    // RESTORE MARKET PRICES
                    STOCKS.forEach(s => {
                        let val = state.stocks[s.sym];
                        if (typeof val === 'number') state.stocks[s.sym] = { qty: val, avg: 0 };
                        else if (!val) state.stocks[s.sym] = { qty: 0, avg: 0 };
                        
                        // Overwrite base price with saved price if exists
                        if(state.marketPrices && state.marketPrices[s.sym]) {
                            s.price = state.marketPrices[s.sym];
                        }
                    });

                    startGame();
                    
                    // Restore chart
                    if(state.marketHistory && state.marketHistory.length > 0) {
                         drawChart(state.marketHistory[state.marketHistory.length-1]);
                    }

                } catch(e) { console.log("Save Error", e); showSetup(); }
            } else {
                showSetup();
            }
        }

        function showSetup() { document.getElementById('setup-screen').style.display = 'block'; }
        
        function selectLogo(icon, el) {
            document.querySelectorAll('.logo-opt').forEach(e => e.classList.remove('selected'));
            el.classList.add('selected');
            state.logo = icon; 
            checkStart();
        }
        
        function selectAvatar(id, el) {
            document.querySelectorAll('.avatar-option').forEach(e => e.classList.remove('selected'));
            el.classList.add('selected');
            state.avatar = id; 
            checkStart();
        }
        
        function checkStart() {
            const name = document.getElementById('input-player-name').value.trim();
            const corp = document.getElementById('input-company-name').value.trim();
            const isValid = (name.length > 0 && corp.length > 0 && state.logo && state.avatar);
            const btn = document.getElementById('btn-start');
            btn.disabled = !isValid;
            if(isValid) {
                btn.style.borderColor = "var(--neon-green)";
                btn.style.color = "var(--neon-green)";
                btn.style.boxShadow = "0 0 20px var(--neon-green)";
            } else {
                btn.style.borderColor = "";
                btn.style.color = "";
                btn.style.boxShadow = "";
            }
        }

        document.getElementById('input-player-name').addEventListener('input', checkStart);
        document.getElementById('input-company-name').addEventListener('input', checkStart);
        
        document.getElementById('btn-start').onclick = () => {
            state.name = document.getElementById('input-player-name').value;
            state.corp = document.getElementById('input-company-name').value;
            startGame(); saveGame(true);
        };

        function startGame() {
            document.getElementById('setup-screen').style.display = 'none';
            document.getElementById('game-layout').style.display = window.innerWidth > 768 ? 'grid' : 'flex'; 
            
            document.getElementById('company-display').innerText = state.corp;
            document.getElementById('ceo-display').innerText = state.name;
            document.getElementById('main-clicker').innerText = state.logo;

            const avEl = document.getElementById('ceo-avatar-display');
            avEl.style.display = 'block';
            if(state.avatar === 1) avEl.style.backgroundPosition = "0% 0%";
            else if(state.avatar === 2) avEl.style.backgroundPosition = "100% 0%";
            else if(state.avatar === 3) avEl.style.backgroundPosition = "0% 100%";
            else if(state.avatar === 4) avEl.style.backgroundPosition = "100% 100%";

            updateUI();
            renderLists();
            updateRocketUI(); 
            
            setInterval(passiveLoop, 1000);
            setInterval(stabilityLoop, 1000); 
            setInterval(marketLoop, 3000); 
            setInterval(newsLoop, 15000);
            setInterval(() => saveGame(true), 10000); 
            setTimeout(spawnAnomaly, Math.random() * 30000 + 30000);
            newsLoop();
        }

        function getManagerBonus(type) {
            let mult = 1;
            state.managers.forEach(m => {
                if(m.perk.type === type || m.perk.type === 'all') mult *= m.perk.val;
            });
            return mult;
        }

        function getClickPower() {
            let base = Math.floor(1 * Math.pow(1.5, state.clickLevel));
            let mult = 1;
            state.upgrades.forEach(id => {
                let u = UPGRADES.find(x => x.id === id);
                if(u && (u.type === 'click' || u.type === 'all')) mult *= u.mult;
            });
            mult *= getManagerBonus('click');
            return Math.floor(base * mult);
        }

        function getPassiveIncome() {
            let base = state.staff.reduce((acc, s) => acc + s.income, 0);
            let mult = 1;
            state.upgrades.forEach(id => {
                let u = UPGRADES.find(x => x.id === id);
                if(u && (u.type === 'passive' || u.type === 'all')) mult *= u.mult;
            });
            mult *= getManagerBonus('passive');
            
            // CRISIS PENALTY
            if (state.stability <= 0) return 0; // Martial Law
            if (state.stability < 20) return Math.floor((base * mult) * 0.5); // Riots
            
            return Math.floor(base * mult);
        }

        function getNextLevelTarget(level) { return Math.floor(50 * Math.pow(2.5, level)); }
        function getPrevLevelTarget(level) { return level === 0 ? 0 : Math.floor(50 * Math.pow(2.5, level - 1)); }

        document.getElementById('main-clicker').onclick = (e) => {
            if(cooldown) return;
            cooldown = true;
            document.getElementById('main-clicker').classList.add('cooldown');
            setTimeout(() => { cooldown = false; document.getElementById('main-clicker').classList.remove('cooldown'); }, 100);
            
            let amount = getClickPower();
            state.cash += amount; state.clicks++;
            checkLevel(); checkAchievements(); updateUI();
            showFloat(e.clientX, e.clientY - 40, `+$${amount.toLocaleString()}`, 'var(--neon-green)');
        };

        function passiveLoop() {
            let inc = getPassiveIncome();
            if(inc > 0) { state.cash += inc; updateUI(); }
        }

        function stabilityLoop() {
            if(state.stability > 0) {
                let decay = 0.2;
                decay *= getManagerBonus('stability'); // Apply manager perk (0.5 val = half decay)
                state.stability -= decay; 
                if(state.stability < 0) state.stability = 0;
            }
            updateStabilityUI();
        }

        function updateStabilityUI() {
            const fill = document.getElementById('stability-fill');
            const txt = document.getElementById('stability-val');
            const overlay = document.getElementById('stability-overlay');
            const repairBtn = document.getElementById('btn-repair');
            
            txt.innerText = state.stability.toFixed(1) + '%';
            fill.style.width = state.stability + '%';
            
            if(state.stability > 50) {
                fill.style.backgroundColor = 'var(--neon-green)';
                overlay.innerText = "STABLE";
                overlay.style.color = "white";
                repairBtn.style.display = 'none';
            } else if(state.stability > 20) {
                fill.style.backgroundColor = 'var(--neon-orange)';
                overlay.innerText = "UNREST";
                overlay.style.color = "black";
                repairBtn.style.display = 'block';
                repairBtn.innerText = "BRIBE OFFICIALS ($1,000)";
            } else if(state.stability > 0) {
                fill.style.backgroundColor = 'var(--neon-red)';
                overlay.innerText = "RIOTS (-50% INCOME)";
                overlay.style.color = "white";
                repairBtn.style.display = 'block';
                repairBtn.innerText = "RESTORE ORDER ($10,000)";
            } else {
                fill.style.width = '100%'; 
                fill.style.backgroundColor = 'var(--neon-red)';
                overlay.innerText = "MARTIAL LAW (INCOME FROZEN)";
                repairBtn.style.display = 'block';
                repairBtn.innerText = "LIFT LOCKDOWN ($50,000)";
            }
        }

        window.bribeOfficials = () => {
            let cost = 1000;
            if(state.stability <= 20) cost = 10000;
            if(state.stability <= 0) cost = 50000;

            if(state.cash >= cost) {
                state.cash -= cost;
                state.stability = 100;
                updateUI(); updateStabilityUI();
                showFloat(window.innerWidth/2, window.innerHeight/2, "ORDER RESTORED", "var(--neon-green)");
            } else {
                alert("Insufficient funds to bribe officials!");
            }
        };

        function checkLevel() {
            let target = getNextLevelTarget(state.clickLevel);
            let prev = getPrevLevelTarget(state.clickLevel);
            let current = state.clicks - prev; 
            let needed = target - prev; 
            let pct = Math.min(100, (current / needed) * 100);
            document.getElementById('progress-bar-fill').style.width = pct + '%';
            document.getElementById('progress-text').innerText = `${state.clicks.toLocaleString()} / ${target.toLocaleString()}`;
            document.getElementById('current-level-display').innerText = state.clickLevel + 1;
            if(state.clicks >= target) {
                state.clickLevel++;
                document.getElementById('main-clicker').style.borderColor = 'var(--neon-pink)';
                setTimeout(() => document.getElementById('main-clicker').style.borderColor = '', 500);
            }
        }

        function checkAchievements() {
            const unlock = (id) => {
                if(!state.achievements.includes(id)) {
                    state.achievements.push(id);
                    document.getElementById(`badge-${id}`).classList.add('unlocked');
                    let ach = ACHIEVEMENTS.find(a => a.id === id);
                    triggerAchievementPopup(ach);
                }
            };
            if(state.clicks >= 100) unlock(1);
            if(state.cash >= 10000) unlock(2);
            if(state.staff.length > 0) unlock(3);
            if(Object.values(state.stocks).some(s => s.qty > 0)) unlock(4);
            if(state.rocketStage >= 4) unlock(5);
            state.achievements.forEach(id => {
                let b = document.getElementById(`badge-${id}`);
                if(b) b.classList.add('unlocked');
            });
        }

        function triggerAchievementPopup(ach) {
            document.getElementById('achievement-icon').innerText = ach.icon;
            document.getElementById('achievement-title').innerText = ach.title;
            document.getElementById('achievement-desc').innerText = ach.desc;
            document.getElementById('achievement-popup').style.display = 'flex';
            fireConfetti();
        }

        function fireConfetti() {
            const cvs = document.getElementById('confetti-canvas');
            const ctx = cvs.getContext('2d');
            cvs.width = window.innerWidth; cvs.height = window.innerHeight;
            let particles = [];
            const colors = ['#00f3ff', '#ff00ff', '#39ff14', '#fff700'];
            for(let i=0; i<100; i++) {
                particles.push({
                    x: window.innerWidth / 2, y: window.innerHeight / 2,
                    vx: (Math.random() - 0.5) * 15, vy: (Math.random() - 0.5) * 15,
                    color: colors[Math.floor(Math.random() * colors.length)],
                    life: 100
                });
            }
            function update() {
                ctx.clearRect(0,0,cvs.width, cvs.height);
                particles.forEach((p, i) => {
                    p.x += p.vx; p.y += p.vy; p.vy += 0.2; 
                    p.life--;
                    ctx.fillStyle = p.color;
                    ctx.fillRect(p.x, p.y, 6, 6);
                    if(p.life <= 0) particles.splice(i, 1);
                });
                if(particles.length > 0) requestAnimationFrame(update);
                else ctx.clearRect(0,0,cvs.width, cvs.height);
            }
            update();
        }

        document.getElementById('btn-hire').onclick = () => {
            hiringType = 'staff';
            if(state.staff.length >= MAX_STAFF) return alert("STAFF CAPACITY REACHED.");
            if(state.cash >= state.hireCost) {
                document.getElementById('modal-title-text').innerText = "NEW EMPLOYEE";
                document.getElementById('hire-modal').style.display = 'flex';
                document.getElementById('new-hire-name').value = '';
                document.getElementById('new-hire-name').focus();
            }
        };

        window.hireManager = () => {
            hiringType = 'manager';
            if(state.managers.length >= MAX_MANAGERS) return alert("BOARD CAPACITY REACHED.");
            if(state.cash >= MANAGER_COST) {
                document.getElementById('modal-title-text').innerText = "HEADHUNT MANAGER";
                document.getElementById('hire-modal').style.display = 'flex';
                document.getElementById('new-hire-name').value = '';
                document.getElementById('new-hire-name').focus();
            }
        };

        function confirmHire() {
            let name = document.getElementById('new-hire-name').value;
            
            if(hiringType === 'staff') {
                if(!name) name = "Drone-" + (state.staff.length+1);
                state.cash -= state.hireCost;
                state.staff.push({ name: name, income: 10 + (state.staff.length * 5) });
                state.hireCost = Math.floor(state.hireCost * 1.5);
            } else {
                if(!name) name = "Executive-" + (state.managers.length+1);
                state.cash -= MANAGER_COST;
                // Assign Random Perk
                let perk = MANAGER_PERKS[Math.floor(Math.random() * MANAGER_PERKS.length)];
                state.managers.push({ name: name, perk: perk });
            }

            closeModal('hire-modal');
            updateUI(); renderLists();
        }

        function fireStaff(index) {
            if(confirm(`Terminate contract for ${state.staff[index].name}?`)) {
                state.staff.splice(index, 1);
                updateUI(); renderLists();
            }
        }
        
        window.fireManager = (index) => {
            if(confirm(`Terminate Executive ${state.managers[index].name}? You will lose their perk.`)) {
                state.managers.splice(index, 1);
                updateUI(); renderLists();
            }
        };

        function buyUpgrade(id) {
            let u = UPGRADES.find(x => x.id === id);
            if(state.cash >= u.cost) {
                state.cash -= u.cost;
                state.upgrades.push(id);
                updateUI(); renderLists();
            }
        }

        function renderLists() {
            // Render Staff
            const sl = document.getElementById('staff-list');
            sl.innerHTML = state.staff.length ? '' : '<div style="text-align:center; color:#555;">No staff online.</div>';
            [...state.staff].reverse().forEach((s, i) => {
                let realIndex = state.staff.length - 1 - i;
                sl.innerHTML += `
                    <div class="list-item">
                        <div>
                            <div style="font-weight:bold;">${s.name}</div>
                            <div style="font-size:0.8rem; color:var(--neon-blue)">+$${s.income}/s</div>
                        </div>
                        <button class="btn btn-danger btn-sm" onclick="fireStaff(${realIndex})">TERMINATE</button>
                    </div>`;
            });

            // Render Managers
            const ml = document.getElementById('manager-list');
            ml.innerHTML = state.managers.length ? '' : '<div style="text-align:center; color:#555;">Board seats empty.</div>';
            [...state.managers].reverse().forEach((m, i) => {
                let realIndex = state.managers.length - 1 - i;
                ml.innerHTML += `
                    <div class="list-item manager-item">
                        <div>
                            <div style="font-weight:bold; color:var(--neon-yellow);">${m.name}</div>
                            <div style="font-size:0.8rem; color:#ccc;">${m.perk.name}</div>
                            <div style="font-size:0.7rem; color:var(--neon-green)">${m.perk.desc}</div>
                        </div>
                        <button class="btn btn-danger btn-sm" onclick="fireManager(${realIndex})">FIRE</button>
                    </div>`;
            });

            // Render Upgrades
            const ul = document.getElementById('upgrade-list');
            const al = document.getElementById('acquired-list');
            ul.innerHTML = ''; al.innerHTML = '';
            let availableCount = 0;
            UPGRADES.forEach(u => {
                let isOwned = state.upgrades.includes(u.id);
                let html = `
                    <div class="list-item" style="align-items: center; ${isOwned ? 'opacity:0.7; border-color:var(--neon-green);' : ''}">
                        <div><div style="font-weight:bold; font-size:0.9rem;">${u.name}</div><div style="font-size:0.8rem; color:#888;">Mult: x${u.mult}</div></div>
                        ${isOwned 
                            ? '<span style="color:var(--neon-green); font-size:0.8rem;">[INSTALLED]</span>' 
                            : `<button class="btn" style="font-size:0.8rem; padding: 6px;" onclick="buyUpgrade('${u.id}')">$${u.cost.toLocaleString()}</button>`
                        }
                    </div>`;
                if(isOwned) al.innerHTML += html;
                else { ul.innerHTML += html; availableCount++; }
            });
            if(availableCount === 0) ul.innerHTML = '<div style="text-align:center; color:#555; font-style:italic;">No upgrades available.</div>';
            if(al.innerHTML === '') al.innerHTML = '<div style="text-align:center; color:#555; font-style:italic;">None acquired.</div>';
        }

        function marketLoop() {
            let index = 0;
            STOCKS.forEach(s => {
                let change = (Math.random() - 0.5) * s.vol * 2; 
                s.price = Math.max(1, s.price * (1 + change));
                index += s.price;
                // SAVE PRICE TO STATE FOR PERSISTENCE
                if(!state.marketPrices) state.marketPrices = {};
                state.marketPrices[s.sym] = s.price;
            });
            renderStocks(); drawChart(index);
        }

        function renderStocks() {
            const sl = document.getElementById('stock-list');
            sl.innerHTML = '';
            STOCKS.forEach(s => {
                if(!state.stocks[s.sym]) state.stocks[s.sym] = { qty: 0, avg: 0 };
                let d = state.stocks[s.sym];
                let avgDisplay = d.qty > 0 ? `(Avg: $${d.avg.toFixed(2)})` : '';
                
                sl.innerHTML += `
                    <div class="stock-item">
                        <div class="stock-row-top">
                            <div>
                                <span style="color:var(--neon-blue); font-weight:bold;">${s.sym}</span>
                                <span style="font-size:0.8rem; color:#888; margin-left: 5px;">Owned: ${d.qty} ${avgDisplay}</span>
                            </div>
                            <div style="font-size:1.1rem;">$${s.price.toFixed(2)}</div>
                        </div>
                        <div class="stock-row-bot">
                            <button class="btn btn-sm" onclick="trade('${s.sym}', 1)">+1</button>
                            <button class="btn btn-sm" onclick="trade('${s.sym}', 5)">+5</button>
                            <button class="btn btn-sm btn-danger" onclick="trade('${s.sym}', -1)">-1</button>
                            <button class="btn btn-sm btn-danger" onclick="trade('${s.sym}', -5)">-5</button>
                            <button class="btn btn-sm btn-danger" style="width:100%; margin-top:5px; border-color:var(--neon-orange); color:var(--neon-orange);" onclick="sellAllStock('${s.sym}')">SELL ALL</button>
                        </div>
                    </div>`;
            });
        }

        window.trade = (sym, qty) => {
            let s = STOCKS.find(x => x.sym === sym);
            let d = state.stocks[sym];
            let cost = s.price * Math.abs(qty);
            if(qty > 0) {
                if(state.cash >= cost) {
                    state.cash -= cost;
                    let totalValue = (d.qty * d.avg) + cost;
                    d.qty += qty;
                    d.avg = totalValue / d.qty;
                }
            } else {
                let sellQty = Math.abs(qty);
                if(d.qty >= sellQty) {
                    state.cash += s.price * sellQty;
                    d.qty -= sellQty;
                    if(d.qty === 0) d.avg = 0;
                }
            }
            updateUI(); renderStocks();
        };

        window.sellAllStock = (sym) => {
            let s = STOCKS.find(x => x.sym === sym);
            let d = state.stocks[sym];
            if(!d || d.qty <= 0) return;
            let total = s.price * d.qty;
            state.cash += total;
            d.qty = 0; d.avg = 0;
            updateUI(); renderStocks();
            showFloat(window.innerWidth/2, window.innerHeight/2, `SOLD ALL ${sym}: +$${Math.floor(total).toLocaleString()}`, 'var(--neon-orange)');
        };

        function drawChart(val) {
            // SYNC HISTORY TO STATE
            if(!state.marketHistory) state.marketHistory = [];
            state.marketHistory.push(val);
            if(state.marketHistory.length > 50) state.marketHistory.shift();
            
            const cvs = document.getElementById('market-chart');
            if(cvs.parentElement.clientWidth > 0) { cvs.width = cvs.parentElement.clientWidth; cvs.height = cvs.parentElement.clientHeight; }
            const ctx = cvs.getContext('2d');
            ctx.clearRect(0,0,cvs.width, cvs.height);
            
            // DRAW GRIDLINES
            ctx.strokeStyle = 'rgba(0, 243, 255, 0.1)';
            ctx.lineWidth = 1;
            ctx.setLineDash([5, 5]); // Dashed lines
            
            // Horizontal Grid
            for(let i=1; i<5; i++) {
                let y = (cvs.height / 5) * i;
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(cvs.width, y);
                ctx.stroke();
            }
            
            // Vertical Grid
            for(let i=1; i<10; i++) {
                let x = (cvs.width / 10) * i;
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, cvs.height);
                ctx.stroke();
            }

            if(state.marketHistory.length < 2) return;
            const min = Math.min(...state.marketHistory) * 0.95; const max = Math.max(...state.marketHistory) * 1.05; const range = max - min;
            const w = cvs.width; const h = cvs.height;
            
            ctx.setLineDash([]); // Reset to solid line for chart
            ctx.strokeStyle = state.marketHistory[state.marketHistory.length-1] > state.marketHistory[0] ? '#39ff14' : '#ff3939';
            ctx.lineWidth = 2; ctx.beginPath();
            state.marketHistory.forEach((v, i) => {
                let x = (i / (state.marketHistory.length - 1)) * w; let y = h - ((v - min) / range) * h;
                if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
            });
            ctx.stroke();
        }

        function updateRocketUI() {
            for(let i=1; i<=4; i++) {
                let el = document.getElementById(`part-${i}`);
                if(i <= state.rocketStage) el.classList.add('built');
            }
            let btn = document.getElementById('btn-fund-rocket');
            let phaseLabel = document.getElementById('rocket-phase-name');

            if(state.rocketStage >= 4) {
                phaseLabel.innerText = "READY FOR LAUNCH";
                phaseLabel.style.color = "var(--neon-green)";
                btn.innerText = "INITIATE LAUNCH SEQUENCE";
                btn.style.borderColor = "var(--neon-green)"; btn.style.color = "var(--neon-green)";
                btn.onclick = launchRocket;
            } else {
                let currentPhase = ROCKET_PHASES[state.rocketStage];
                phaseLabel.innerText = currentPhase.name;
                phaseLabel.style.color = "var(--neon-blue)";
                btn.innerText = `FUND PHASE ($${currentPhase.cost.toLocaleString()})`;
                btn.onclick = fundRocket;
                if(state.cash < currentPhase.cost) { btn.style.opacity = 0.5; btn.style.cursor = "not-allowed"; } 
                else { btn.style.opacity = 1; btn.style.cursor = "pointer"; }
            }
        }

        function fundRocket() {
            if(state.rocketStage >= 4) return;
            let cost = ROCKET_PHASES[state.rocketStage].cost;
            if(state.cash >= cost) {
                state.cash -= cost; state.rocketStage++;
                updateUI(); updateRocketUI(); saveGame(true);
            }
        }

        function launchRocket() {
            if(confirm("LAUNCH PROJECT EXODUS?")) {
                document.getElementById('rocket-silo').classList.add('rocket-launching');
                setTimeout(() => { alert("CONGRATULATIONS. YOU WIN."); state.rocketStage = 0; }, 3000);
            }
        }

        function showFloat(x, y, text, color) {
            let float = document.createElement('div');
            float.className = 'floating-text'; float.innerText = text;
            float.style.left = x + 'px'; float.style.top = y + 'px'; float.style.color = color || 'white';
            document.body.appendChild(float);
            setTimeout(() => float.remove(), 1000);
        }

        function spawnAnomaly() {
            let orb = document.getElementById('anomaly');
            orb.style.display = 'block';
            orb.style.left = Math.random() * (window.innerWidth - 60) + 'px';
            orb.style.top = Math.random() * (window.innerHeight - 60) + 'px';
            setTimeout(() => orb.style.display = 'none', 5000);
            setTimeout(spawnAnomaly, Math.random() * 30000 + 30000);
        }
        document.getElementById('anomaly').onclick = function() {
            this.style.display = 'none';
            let bonus = Math.floor(getClickPower() * 100);
            state.cash += bonus;
            document.getElementById('anomaly-amount').innerText = bonus.toLocaleString();
            document.getElementById('anomaly-popup').style.display = 'flex';
            updateUI();
        };

        function closeModal(id) { 
            let el = document.getElementById(id);
            if(el) el.style.display = 'none'; 
            if(id === 'embezzle-popup') {
                el.classList.remove('failed', 'success');
            }
        }
        window.closeModal = closeModal;

        function updateUI() {
            document.getElementById('currency-count').innerText = Math.floor(state.cash).toLocaleString();
            document.getElementById('click-power-display').innerText = Math.floor(getClickPower()).toLocaleString();
            document.getElementById('passive-income-display').innerText = Math.floor(getPassiveIncome()).toLocaleString();
            
            let hireBtn = document.getElementById('btn-hire');
            if(state.staff.length >= MAX_STAFF) { hireBtn.disabled = true; hireBtn.innerText = "FULL"; } 
            else { hireBtn.disabled = state.cash < state.hireCost; hireBtn.innerText = `HIRE ($${state.hireCost.toLocaleString()})`; }
            document.getElementById('staff-counter').innerText = `(${state.staff.length}/${MAX_STAFF})`;
            
            // Managers UI
            let manBtn = document.getElementById('btn-hire-manager');
            if(state.managers.length >= MAX_MANAGERS) { manBtn.disabled = true; manBtn.innerText = "FULL"; }
            else { manBtn.disabled = state.cash < MANAGER_COST; manBtn.innerText = `HEADHUNT ($${MANAGER_COST.toLocaleString()})`; }
            document.getElementById('manager-counter').innerText = `(${state.managers.length}/${MAX_MANAGERS})`;

            checkAchievements(); updateRocketUI(); updateStabilityUI();
        }

        window.switchTab = (t) => {
            document.querySelectorAll('.tab-content').forEach(e => e.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(e => e.classList.remove('active'));
            document.getElementById('tab-'+t).classList.add('active');
            let btns = document.querySelectorAll('.tab-btn');
            if(t==='staff') btns[0].classList.add('active');
            if(t==='blackmarket') btns[1].classList.add('active');
            if(t==='stocks') btns[2].classList.add('active');
            if(t==='projectx') btns[3].classList.add('active');
            
            if(t==='stocks') {
                const cvs = document.getElementById('market-chart');
                cvs.width = cvs.parentElement.clientWidth;
                cvs.height = cvs.parentElement.clientHeight;
            }
        };

        function newsLoop() {
            let item = NEWS_ITEMS[Math.floor(Math.random() * NEWS_ITEMS.length)];
            document.getElementById('news-ticker').innerText = item + " ... " + item;
        }

        function saveGame(silent) {
            localStorage.setItem('neonV21', JSON.stringify(state));
            if(!silent) {
                let btn = document.getElementById('btn-save');
                let rect = btn.getBoundingClientRect();
                showFloat(rect.left, rect.top - 20, "GAME SAVED", '#fff');
            }
        }
        window.saveGame = saveGame; 
        window.resetGame = () => { if(confirm("Wipe all data?")) { localStorage.removeItem('neonV21'); location.reload(); } };
        
        window.gamble = () => {
            if(state.cash < 100) return alert("Need $100");
            let popup = document.getElementById('embezzle-popup');
            let title = document.getElementById('embezzle-title');
            let msg = document.getElementById('embezzle-message');
            let bet = Math.floor(state.cash * 0.25);
            state.cash -= bet;
            popup.classList.remove('failed', 'success');
            popup.style.display = 'flex';
            if(Math.random() > 0.5) { 
                let gain = bet * 2;
                state.cash += gain; 
                popup.classList.add('success');
                title.innerText = "EMBEZZLEMENT SUCCESSFUL";
                title.style.color = "var(--neon-green)";
                msg.innerText = `You secured +$${gain.toLocaleString()} through offshore accounts.`;
            } else { 
                popup.classList.add('failed');
                title.innerText = "FUNDS SEIZED";
                title.style.color = "var(--neon-red)";
                msg.innerText = `Auditors froze the transfer. You lost $${bet.toLocaleString()}.`;
            }
            updateUI();
        };

        init();
    </script>
</body>
</html>
